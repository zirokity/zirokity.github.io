<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì° Propagacja PL</title>
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0d0d0d;
            color: #ddd;
            padding: 15px;
            line-height: 1.5;
        }
        .container {
            max-width: 750px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        h1 {
            font-size: 1.9em;
            color: #5eead4;
            letter-spacing: -0.5px;
        }
        .subtitle {
            color: #777;
            font-size: 0.95em;
            margin-top: 5px;
        }
        
        /* G≈Å√ìWNE DANE ‚Äì na wierzchu */
        .main-data {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            background: #151515;
            padding: 18px;
            border-radius: 6px;
        }
        .data-item {
            text-align: center;
            flex: 1;
            padding: 0 8px;
        }
        .data-label {
            font-size: 0.85em;
            color: #777;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .data-value {
            font-size: 2.4em;
            font-weight: bold;
        }
        .sfi-good, .k-good { color: #34d399; }
        .sfi-medium, .k-medium { color: #fbbf24; }
        .sfi-bad, .k-bad { color: #f87171; }
        
        /* Pasma ‚Äì od razu pod danymi */
        .bands {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }
        .band {
            background: #151515;
            padding: 14px 8px;
            border-radius: 5px;
            text-align: center;
            transition: background 0.2s;
        }
        .band:hover {
            background: #1a1a1a;
        }
        .band-label {
            font-size: 1.05em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #5eead4;
        }
        .band-status {
            font-size: 0.9em;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 3px;
        }
        .band-good { background: #0d4d26; color: #a7f3d0; }
        .band-medium { background: #4a2109; color: #fef3c7; }
        .band-bad { background: #450a0a; color: #fecaca; }
        
        /* Zegary ‚Äì ma≈Çe, dyskretne */
        .clocks {
            display: flex;
            justify-content: space-between;
            background: #151515;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        .clock {
            text-align: center;
            flex: 1;
        }
        .clock-time {
            font-size: 1.6em;
            font-weight: bold;
            color: #5eead4;
            margin-bottom: 4px;
        }
        .clock-label {
            color: #777;
            font-size: 0.85em;
        }
        .day-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 8px;
            vertical-align: middle;
        }
        .day-badge.day { background: #4a2109; color: #fef3c7; }
        .day-badge.night { background: #0e2a47; color: #93c5fd; }
        .day-badge.dawn { background: #431407; color: #ffedd5; }
        
        /* Dodatkowe info ‚Äì na dole, ma≈Çe */
        .extras {
            background: #151515;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #888;
        }
        .extras-title {
            color: #777;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
        }
        .sun-times {
            display: flex;
            justify-content: space-around;
            margin-top: 8px;
        }
        .sun-item {
            text-align: center;
        }
        .sun-time {
            font-weight: bold;
            color: #fbbf24;
        }
        
        .refresh-btn {
            width: 100%;
            padding: 11px;
            background: #1a1a1a;
            color: #5eead4;
            border: 1px solid #333;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1.05em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: #202020;
            border-color: #5eead4;
        }
        .refresh-btn:active {
            transform: scale(0.98);
        }
        
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid #2a2a2a;
        }
        
        .toast-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
        }
        .toast {
            background: #1a1a1a;
            color: #ddd;
            padding: 10px 18px;
            border-radius: 5px;
            margin-bottom: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            border-left: 3px solid #5eead4;
            min-width: 260px;
            font-size: 0.95em;
        }
        .toast.good { border-left-color: #34d399; }
        .toast.bad { border-left-color: #f87171; }
        .toast.warning { border-left-color: #fbbf24; }
        
        @media (max-width: 550px) {
            .main-data { flex-direction: column; gap: 15px; }
            .clocks { flex-direction: column; gap: 12px; }
            .bands { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
            .band-label { font-size: 0.95em; }
            h1 { font-size: 1.7em; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div class="container">
        <header>
            <h1>üì° Propagacja PL</h1>
            <div class="subtitle">Dane na ≈ºywo z hamqsl.com</div>
        </header>

        <!-- G≈Å√ìWNE DANE ‚Äì najwa≈ºniejsze na g√≥rze -->
        <div class="main-data">
            <div class="data-item">
                <div class="data-label">SFI</div>
                <div class="data-value sfi-good" id="sfi">?</div>
            </div>
            <div class="data-item">
                <div class="data-label">K-index</div>
                <div class="data-value k-good" id="kindex">?</div>
            </div>
            <div class="data-item">
                <div class="data-label">A-index</div>
                <div class="data-value" id="aindex">?</div>
            </div>
        </div>

        <!-- Pasma ‚Äì od razu pod danymi -->
        <div class="bands" id="bands">
            <div class="band">
                <div class="band-label">160m</div>
                <div class="band-status band-medium" id="band-160m">≈öREDNIO</div>
            </div>
            <div class="band">
                <div class="band-label">80m</div>
                <div class="band-status band-good" id="band-80m">DOBRZE</div>
            </div>
            <div class="band">
                <div class="band-label">40m</div>
                <div class="band-status band-good" id="band-40m">DOBRZE</div>
            </div>
            <div class="band">
                <div class="band-label">30m</div>
                <div class="band-status band-good" id="band-30m">DOBRZE</div>
            </div>
            <div class="band">
                <div class="band-label">20m</div>
                <div class="band-status band-good" id="band-20m">DOBRZE</div>
            </div>
            <div class="band">
                <div class="band-label">17m</div>
                <div class="band-status band-medium" id="band-17m">≈öREDNIO</div>
            </div>
            <div class="band">
                <div class="band-label">15m</div>
                <div class="band-status band-medium" id="band-15m">≈öREDNIO</div>
            </div>
            <div class="band">
                <div class="band-label">12m</div>
                <div class="band-status band-bad" id="band-12m">≈πLE</div>
            </div>
            <div class="band">
                <div class="band-label">10m</div>
                <div class="band-status band-bad" id="band-10m">≈πLE</div>
            </div>
        </div>

        <!-- Zegary ‚Äì ma≈Çe, z badge'em dnia/nocy -->
        <div class="clocks">
            <div class="clock">
                <div class="clock-time" id="polish-time">--:--:--</div>
                <div class="clock-label">PL <span class="day-badge" id="day-badge">...</span></div>
            </div>
            <div class="clock">
                <div class="clock-time" id="utc-time">--:--:--</div>
                <div class="clock-label">UTC</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="refreshData()">Od≈õwie≈º</button>

        <!-- Dodatkowe info ‚Äì na dole -->
        <div class="extras">
            <div class="extras-title">üåÖ Wsch√≥d/zach√≥d S≈Ço≈Ñca (Warszawa)</div>
            <div class="sun-times">
                <div class="sun-item">
                    <div>üåÖ</div>
                    <div class="sun-time" id="sunrise">--:--</div>
                    <div>wsch√≥d</div>
                </div>
                <div class="sun-item">
                    <div>üåá</div>
                    <div class="sun-time" id="sunset">--:--</div>
                    <div>zach√≥d</div>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp">≈Åadowanie...</div>
    </div>

    <script>
        let prevK = null, prevSFI = null, lastToast = 0;

        function updateClock() {
            const now = new Date();
            const plTime = now.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Europe/Warsaw'});
            const plDate = now.toLocaleDateString('pl-PL', {day:'2-digit',month:'2-digit',year:'numeric',timeZone:'Europe/Warsaw'});
            const utcTime = now.toISOString().substring(11, 19);
            
            document.getElementById('polish-time').textContent = plTime;
            document.getElementById('utc-time').textContent = utcTime;
            
            // Aktualizuj badge dnia/nocy
            updateDayBadge();
        }

        function updateDayBadge() {
            const now = new Date();
            const times = SunCalc.getTimes(now, 52.2297, 21.0122);
            const badge = document.getElementById('day-badge');
            
            const isNight = now < times.sunrise || now > times.sunset;
            const dawnStart = new Date(times.sunrise.getTime() - 20*60000);
            const dawnEnd = new Date(times.sunrise.getTime() + 20*60000);
            const duskStart = new Date(times.sunset.getTime() - 20*60000);
            const duskEnd = new Date(times.sunset.getTime() + 20*60000);
            const isDawn = now >= dawnStart && now <= dawnEnd;
            const isDusk = now >= duskStart && now <= duskEnd;
            
            if (isNight) {
                badge.textContent = "noc";
                badge.className = "day-badge night";
            } else if (isDawn || isDusk) {
                badge.textContent = isDawn ? "≈õwit" : "zmierzch";
                badge.className = "day-badge dawn";
            } else {
                badge.textContent = "dzie≈Ñ";
                badge.className = "day-badge day";
            }
        }

        function calcSunTimes() {
            const now = new Date();
            const times = SunCalc.getTimes(now, 52.2297, 21.0122);
            const fmt = d => d.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit'});
            document.getElementById('sunrise').textContent = fmt(times.sunrise);
            document.getElementById('sunset').textContent = fmt(times.sunset);
        }

        function showToast(msg, type='info') {
            const now = Date.now();
            if (now - lastToast < 10000) return;
            lastToast = now;
            
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(() => t.remove(), 300); }, 4000);
        }

        function checkChanges(k, sfi) {
            if (prevK !== null && k !== prevK) {
                if (k <= 2 && prevK > 2) showToast(`K-index ${k} ‚Äì propagacja lepsza!`, 'good');
                else if (k >= 5 && prevK < 5) showToast(`K-index ${k} ‚Äì propagacja gorsza`, 'bad');
            }
            prevK = k; prevSFI = sfi;
        }

        async function fetchData() {
            try {
                const r = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://www.hamqsl.com/solarxml.php')}`);
                if (!r.ok) throw new Error();
                const xml = await r.text();
                const doc = new DOMParser().parseFromString(xml, "text/xml");
                if (doc.querySelector('parsererror')) throw new Error();
                
                const sfi = parseInt(doc.querySelector('solarflux')?.textContent || '0');
                const k = parseInt(doc.querySelector('kindex')?.textContent || '0');
                const a = parseInt(doc.querySelector('aindex')?.textContent || '0');
                
                if (sfi < 50 || sfi > 300 || isNaN(sfi)) throw new Error();
                if (k < 0 || k > 9 || isNaN(k)) throw new Error();
                
                return {sfi, k, a, ts: new Date().toLocaleString('pl-PL'), live: true};
            } catch (e) {
                // Fallback na mock
                const h = new Date().getUTCHours();
                return {
                    sfi: 130 + Math.floor(Math.random()*25) - 12,
                    k: h >= 22 || h < 6 ? 1 + Math.floor(Math.random()*2) : 2 + Math.floor(Math.random()*3),
                    a: 8,
                    ts: new Date().toLocaleString('pl-PL'),
                    live: false
                };
            }
        }

        function evalBand(band, k, sfi) {
            if (k <= 2 && sfi > 120) return ['10m','12m','15m','17m','20m'].includes(band) ? ['DOBRZE','good'] : ['DOBRZE','good'];
            if (k <= 3 && sfi > 100) return ['10m','12m'].includes(band) ? ['≈öREDNIO','medium'] : ['15m','17m'].includes(band) ? ['DOBRZE','good'] : ['DOBRZE','good'];
            if (k <= 4) return ['10m','12m','15m'].includes(band) ? ['≈πLE','bad'] : ['17m','20m'].includes(band) ? ['≈öREDNIO','medium'] : ['DOBRZE','good'];
            return ['10m','12m','15m','17m','20m'].includes(band) ? ['≈πLE','bad'] : ['30m','40m'].includes(band) ? ['≈öREDNIO','medium'] : ['DOBRZE','good'];
        }

        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                const d = await fetchData();
                document.getElementById('sfi').textContent = d.sfi;
                document.getElementById('kindex').textContent = d.k;
                document.getElementById('aindex').textContent = d.a;
                document.getElementById('timestamp').textContent = `Aktualizacja: ${d.ts}`;
                
                // Kolory SFI/K
                const sfiEl = document.getElementById('sfi');
                const kEl = document.getElementById('kindex');
                sfiEl.className = `data-value ${d.sfi > 150 ? 'sfi-good' : d.sfi > 100 ? 'sfi-medium' : 'sfi-bad'}`;
                kEl.className = `data-value ${d.k <= 2 ? 'k-good' : d.k <= 4 ? 'k-medium' : 'k-bad'}`;
                
                // Pasma
                ['160m','80m','40m','30m','20m','17m','15m','12m','10m'].forEach(b => {
                    const [status, cls] = evalBand(b, d.k, d.sfi);
                    const el = document.getElementById(`band-${b}`);
                    el.textContent = status;
                    el.className = `band-status band-${cls}`;
                });
                
                // Alert je≈õli zmiana
                checkChanges(d.k, d.sfi);
                
            } catch (e) {
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Od≈õwie≈º';
            }
        }

        // Init
        calcSunTimes();
        setInterval(calcSunTimes, 3600000);
        updateClock();
        setInterval(updateClock, 1000);
        refreshData();
        setInterval(refreshData, 300000);
    </script>
</body>
</html>
